name: Bundle Size Check

on:
    pull_request:
        branches: [main, develop]

permissions:
    contents: read
    pull-requests: write

jobs:
    size:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install

            - name: Build
              run: pnpm run build

            - name: Check bundle size
              run: |
                  echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
                  echo "|------|------|" >> $GITHUB_STEP_SUMMARY

                  find dist -type f -name "*.js" | while read file; do
                    size=$(du -h "$file" | cut -f1)
                    name=$(basename "$file")
                    echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
                  done

                  echo "" >> $GITHUB_STEP_SUMMARY
                  total=$(du -sh dist | cut -f1)
                  echo "**Total dist size:** $total" >> $GITHUB_STEP_SUMMARY

            - name: Comment PR with bundle size
              uses: actions/github-script@v7
              with:
                  script: |
                      const { execSync } = require('child_process');
                      const totalSize = execSync('du -sh dist').toString().split('\t')[0];

                      const comment = `## ðŸ“¦ Bundle Size Report

                      **Total dist size:** ${totalSize}

                      <details>
                      <summary>View detailed breakdown</summary>

                      \`\`\`
                      ${execSync('du -h dist/*').toString()}
                      \`\`\`

                      </details>
                                `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
