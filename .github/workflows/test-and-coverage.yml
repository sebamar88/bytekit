name: Tests and Coverage

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [20.x, 22.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install

            - name: Run linter
              run: pnpm run lint

            - name: Build project
              run: pnpm run build
            - name: Run tests
              run: pnpm test

    coverage:
        name: Code Coverage
        runs-on: ubuntu-latest
        needs: test
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install

            - name: Build project
              run: pnpm run build

            - name: Run tests with coverage and JUnit report
              run: |
                  pnpm run test:coverage
                  pnpm run test:junit

            - name: Upload test results to Codecov
              if: ${{ !cancelled() }}
              uses: codecov/test-results-action@v1
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./test-report.junit.xml

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-bytekit
                  fail_ci_if_error: false
                  verbose: true

            - name: Extract coverage summary
              id: coverage
              run: |
                  # Extract coverage percentage from output
                  COVERAGE=$(grep -oP 'all files\s+\|\s+\K[\d.]+' coverage/lcov-report/index.html | head -1 || echo "0")
                  echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
                  echo "Coverage: $COVERAGE%"

            - name: Create coverage badge
              if: ${{ env.GIST_SECRET != '' && env.GIST_ID != '' }}
              uses: schneegans/dynamic-badges-action@v1.7.0
              env:
                  GIST_SECRET: ${{ secrets.GIST_SECRET }}
                  GIST_ID: ${{ secrets.GIST_ID }}
              with:
                  auth: ${{ env.GIST_SECRET }}
                  gistID: ${{ env.GIST_ID }}
                  filename: bytekit-coverage.json
                  label: Coverage
                  message: ${{ steps.coverage.outputs.coverage }}%
                  valColorRange: ${{ steps.coverage.outputs.coverage }}
                  maxColorRange: 100
                  minColorRange: 0

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage_output.txt
                  retention-days: 30

            - name: Comment coverage on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const coverage = '${{ steps.coverage.outputs.coverage }}';
                      const comment = `## üìä Code Coverage Report

                      **Coverage:** ${coverage}%

                      ${coverage >= 80 ? '‚úÖ Great coverage!!' : coverage >= 60 ? '‚ö†Ô∏è Coverage could be improved' : '‚ùå Low coverage - please add more tests'}
                      `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
